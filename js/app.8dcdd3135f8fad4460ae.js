(()=>{"use strict";const e=document.getElementById("canvas"),t=document.getElementById("canvasContainer"),a=e.getContext("2d"),n=document.getElementById("upload"),d=document.getElementById("scaleCheckbox"),s=document.getElementById("debug"),i=document.getElementById("download"),r=document.getElementById("imageListContainer"),l=document.getElementById("imageList"),o=document.getElementById("helpText"),c=["testimg/1.jpg","testimg/triangle.png"],m=window.matchMedia("(max-width: 600px)");let g=[],h=null,u=null;const L=()=>t.classList.add("hidden");L(),r.classList.add("hidden");const p=e=>new Promise(((t,a)=>{const n=new FileReader;n.onload=()=>{const d=new Image;d.onload=()=>{d.originalName=e.name,t(d)},d.onerror=()=>a(`Failed to load image: ${e.name}`),d.src=n.result},n.onerror=()=>a(`Failed to read file: ${e.name}`),n.readAsDataURL(e)})),E=async()=>{try{L(),r.classList.add("hidden"),l.innerHTML="",g=await Promise.all(c.map((e=>new Promise(((t,a)=>{const n=new Image;n.onload=()=>t(n),n.onerror=()=>a(`Failed to load image: ${e}`),n.src=e}))))),g.length>0&&(v(),x())}catch(e){console.error("Error loading test images:",e)}},v=()=>{r.classList.remove("hidden"),g.forEach(((e,t)=>{const a=document.createElement("div");a.className="image-thumbnail",a.draggable=!0,a.dataset.index=t;const n=document.createElement("button");n.className="up-arrow",n.innerHTML="&uarr;",0===t?(n.disabled=!0,n.classList.add("disabled")):t>0&&(n.disabled=!1,n.classList.remove("disabled")),n.addEventListener("click",(()=>{(e=>{e<=0||([g[e],g[e-1]]=[g[e-1],g[e]],l.innerHTML="",v(),x())})(t)}));const d=document.createElement("button");d.className="down-arrow",d.innerHTML="&darr;",t===g.length-1?(d.disabled=!0,d.classList.add("disabled")):t<g.length-1&&(d.disabled=!1,d.classList.remove("disabled")),d.addEventListener("click",(()=>{(e=>{e>=g.length-1||([g[e],g[e+1]]=[g[e+1],g[e]],l.innerHTML="",v(),x())})(t)}));const s=document.createElement("div");s.className="preview-container";const i=document.createElement("img");i.className="thumbnail-img",i.src=e.src;const r=e.originalName||e.src.split("/").pop(),o=document.createElement("span");o.className="thumbnail-label",o.textContent=`${r}`,s.appendChild(i),s.appendChild(o),a.appendChild(n),a.appendChild(s),a.appendChild(d),l.appendChild(a),a.addEventListener("dragstart",b),a.addEventListener("dragover",w),a.addEventListener("dragend",f)}))},b=e=>{h=e.target.closest(".image-thumbnail"),u=parseInt(h.dataset.index),h.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",h)},w=e=>{e.preventDefault(),e.dataTransfer.dropEffect="move";const t=e.target.closest(".image-thumbnail");if(!t||t===h)return;const a=parseInt(t.dataset.index);u<a?l.insertBefore(h,t.nextSibling):l.insertBefore(h,t),y()},f=()=>{h&&(h.classList.remove("dragging"),h=null)},y=()=>{const e=Array.from(l.children),t=e.map((e=>g[parseInt(e.dataset.index)]));g=t,e.forEach(((e,t)=>{e.dataset.index=t;const a=e.querySelector(".up-arrow"),n=e.querySelector(".down-arrow");0===t?(a.disabled=!0,a.classList.add("disabled")):0!==t&&(a.disabled=!1,a.classList.remove("disabled")),t===g.length-1?(n.disabled=!0,n.classList.add("disabled")):t!==g.length-1&&(n.disabled=!1,n.classList.remove("disabled"))})),x()},x=()=>{if(0===g.length)return void L();t.classList.remove("hidden");const e=I(g),a=T(g,e),n=B(g,a);C(e,n),M(g,a,e,n)},I=e=>d.checked?Math.max(...e.map((e=>e.width))):Math.min(...e.map((e=>e.width))),T=(e,t)=>e.map((e=>t/e.width)),B=(e,t)=>e.map(((e,a)=>e.height*t[a])),C=(t,a)=>{e.width=t,e.height=a.reduce(((e,t)=>e+t),0)},M=(e,t,n,d)=>{let s=0;e.forEach(((e,t)=>{a.drawImage(e,0,s,n,d[t]),s+=d[t]}))},k=e=>{e.matches?o.innerText="Use the arrows to adjust image order.":o.innerText="Drag images to reorder or use the arrows."};function N(e){const t=e.target.files;t.length&&((async e=>{try{L(),r.classList.add("hidden"),l.innerHTML="",g=await Promise.all(Array.from(e).map(p)),g.length>0?(v(),x()):L()}catch(e){console.error(e),L()}})(t),e.target.value="")}m.addEventListener("change",k),k(m),n.removeEventListener("change",N),n.addEventListener("change",N),d.addEventListener("change",x),i.addEventListener("click",(()=>{const t=document.getElementById("filename").value.trim()||"joinedimage",a=e.toDataURL("image/jpeg",.92),n=document.createElement("a");n.href=a,n.download=`${t}.jpg`,n.click()})),s.addEventListener("change",(t=>{t.target.checked?E():(a.clearRect(0,0,e.width,e.height),L(),r.classList.add("hidden"),l.innerHTML="",g=[])})),s.checked&&E()})();