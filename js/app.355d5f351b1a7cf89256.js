(()=>{"use strict";const e=document.getElementById("canvas"),t=document.getElementById("canvasContainer"),a=e.getContext("2d"),n=document.getElementById("upload"),d=document.getElementById("scaleCheckbox"),s=document.getElementById("debug"),i=document.getElementById("download"),r=document.getElementById("imageListContainer"),l=document.getElementById("imageList"),c=["testimg/1.jpg","testimg/2.png","testimg/rect.png"];let o=[],m=null,g=null;const h=()=>t.classList.add("hidden");h(),r.classList.add("hidden");const u=e=>new Promise(((t,a)=>{const n=new FileReader;n.onload=()=>{const d=new Image;d.onload=()=>{d.originalName=e.name,t(d)},d.onerror=()=>a(`Failed to load image: ${e.name}`),d.src=n.result},n.onerror=()=>a(`Failed to read file: ${e.name}`),n.readAsDataURL(e)})),L=async()=>{try{h(),r.classList.add("hidden"),l.innerHTML="",o=await Promise.all(c.map((e=>new Promise(((t,a)=>{const n=new Image;n.onload=()=>t(n),n.onerror=()=>a(`Failed to load image: ${e}`),n.src=e}))))),o.length>0&&(p(),f())}catch(e){console.error("Error loading test images:",e)}},p=()=>{r.classList.remove("hidden"),o.forEach(((e,t)=>{const a=document.createElement("div");a.className="image-thumbnail",a.draggable=!0,a.dataset.index=t;const n=document.createElement("button");n.className="up-arrow",n.innerHTML="&uarr;",0===t?(n.disabled=!0,n.classList.add("disabled")):t>0&&(n.disabled=!1,n.classList.remove("disabled")),n.addEventListener("click",(()=>{(e=>{e<=0||([o[e],o[e-1]]=[o[e-1],o[e]],l.innerHTML="",p(),f())})(t)}));const d=document.createElement("button");d.className="down-arrow",d.innerHTML="&darr;",t===o.length-1?(d.disabled=!0,d.classList.add("disabled")):t<o.length-1&&(d.disabled=!1,d.classList.remove("disabled")),d.addEventListener("click",(()=>{(e=>{e>=o.length-1||([o[e],o[e+1]]=[o[e+1],o[e]],l.innerHTML="",p(),f())})(t)}));const s=document.createElement("div");s.className="preview-container";const i=document.createElement("img");i.src=e.src;const r=e.originalName||e.src.split("/").pop(),c=document.createElement("span");c.className="thumbnail-label",c.textContent=`${r}`,s.appendChild(i),s.appendChild(c),a.appendChild(n),a.appendChild(s),a.appendChild(d),l.appendChild(a),a.addEventListener("dragstart",E),a.addEventListener("dragover",v),a.addEventListener("dragend",b)}))},E=e=>{m=e.target.closest(".image-thumbnail"),g=parseInt(m.dataset.index),m.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",m)},v=e=>{e.preventDefault(),e.dataTransfer.dropEffect="move";const t=e.target.closest(".image-thumbnail");if(!t||t===m)return;const a=parseInt(t.dataset.index);g<a?l.insertBefore(m,t.nextSibling):l.insertBefore(m,t),w()},b=()=>{m&&(m.classList.remove("dragging"),m=null)},w=()=>{const e=Array.from(l.children),t=e.map((e=>o[parseInt(e.dataset.index)]));o=t,e.forEach(((e,t)=>{e.dataset.index=t;const a=e.querySelector(".up-arrow"),n=e.querySelector(".down-arrow");0===t?(a.disabled=!0,a.classList.add("disabled")):0!==t&&(a.disabled=!1,a.classList.remove("disabled")),t===o.length-1?(n.disabled=!0,n.classList.add("disabled")):t!==o.length-1&&(n.disabled=!1,n.classList.remove("disabled"))})),f()},f=()=>{if(0===o.length)return void h();t.classList.remove("hidden");const e=y(o),a=I(o,e),n=x(o,a);B(e,n),C(o,a,e,n)},y=e=>d.checked?Math.max(...e.map((e=>e.width))):Math.min(...e.map((e=>e.width))),I=(e,t)=>e.map((e=>t/e.width)),x=(e,t)=>e.map(((e,a)=>e.height*t[a])),B=(t,a)=>{e.width=t,e.height=a.reduce(((e,t)=>e+t),0)},C=(e,t,n,d)=>{let s=0;e.forEach(((e,t)=>{a.drawImage(e,0,s,n,d[t]),s+=d[t]}))};function T(e){const t=e.target.files;t.length&&((async e=>{try{h(),r.classList.add("hidden"),l.innerHTML="",o=await Promise.all(Array.from(e).map(u)),o.length>0?(p(),f()):h()}catch(e){console.error(e),h()}})(t),e.target.value="")}n.removeEventListener("change",T),n.addEventListener("change",T),d.addEventListener("change",f),i.addEventListener("click",(()=>{const t=document.getElementById("filename").value.trim()||"joinedimage",a=e.toDataURL("image/jpeg",.92),n=document.createElement("a");n.href=a,n.download=`${t}.jpg`,n.click()})),s.addEventListener("change",(t=>{t.target.checked?L():(a.clearRect(0,0,e.width,e.height),h(),r.classList.add("hidden"),l.innerHTML="",o=[])})),s.checked&&L()})();