(()=>{"use strict";const e=document.getElementById("canvas"),t=document.getElementById("canvasContainer"),a=e.getContext("2d"),n=document.getElementById("upload"),d=document.getElementById("scaleCheckbox"),s=document.getElementById("debug"),i=document.getElementById("debugContainer"),r=document.getElementById("download"),l=document.getElementById("imageListContainer"),o=document.getElementById("imageList"),c=document.getElementById("helpText"),m=["testimg/1.jpg","testimg/triangle.png"],g=window.matchMedia("(max-width: 600px)");i.style.display="none";let h=[],u=null,p=null;const L=()=>t.classList.add("hidden");L(),l.classList.add("hidden");const E=e=>new Promise(((t,a)=>{const n=new FileReader;n.onload=()=>{const d=new Image;d.onload=()=>{d.originalName=e.name,t(d)},d.onerror=()=>a(`Failed to load image: ${e.name}`),d.src=n.result},n.onerror=()=>a(`Failed to read file: ${e.name}`),n.readAsDataURL(e)})),v=async()=>{try{L(),l.classList.add("hidden"),o.innerHTML="",h=await Promise.all(m.map((e=>new Promise(((t,a)=>{const n=new Image;n.onload=()=>t(n),n.onerror=()=>a(`Failed to load image: ${e}`),n.src=e}))))),h.length>0&&(w(),I())}catch(e){console.error("Error loading test images:",e)}},w=()=>{l.classList.remove("hidden"),h.forEach(((e,t)=>{const a=document.createElement("div");a.className="image-thumbnail",a.draggable=!0,a.dataset.index=t;const n=(e=>{const t=document.createElement("canvas"),a=t.getContext("2d");return t.width=100,t.height=100,a.drawImage(e,0,0,100,100),t.toDataURL("image/jpeg",.7)})(e),d=document.createElement("button");d.className="up-arrow",d.innerHTML="&uarr;",0===t?(d.disabled=!0,d.classList.add("disabled")):t>0&&(d.disabled=!1,d.classList.remove("disabled")),d.addEventListener("click",(()=>{(e=>{e<=0||([h[e],h[e-1]]=[h[e-1],h[e]],o.innerHTML="",w(),I())})(t)}));const s=document.createElement("button");s.className="down-arrow",s.innerHTML="&darr;",t===h.length-1?(s.disabled=!0,s.classList.add("disabled")):t<h.length-1&&(s.disabled=!1,s.classList.remove("disabled")),s.addEventListener("click",(()=>{(e=>{e>=h.length-1||([h[e],h[e+1]]=[h[e+1],h[e]],o.innerHTML="",w(),I())})(t)}));const i=document.createElement("div");i.className="preview-container";const r=document.createElement("img");r.className="thumbnail-img",r.src=n,r.addEventListener("contextmenu",(e=>{e.preventDefault()}));const l=e.originalName||e.src.split("/").pop(),c=document.createElement("span");c.className="thumbnail-label",c.textContent=`${l}`,i.appendChild(r),i.appendChild(c),a.appendChild(d),a.appendChild(i),a.appendChild(s),o.appendChild(a),a.addEventListener("dragstart",b),a.addEventListener("dragover",f),a.addEventListener("dragend",y)}))},b=e=>{u=e.target.closest(".image-thumbnail"),p=parseInt(u.dataset.index),u.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",u)},f=e=>{e.preventDefault(),e.dataTransfer.dropEffect="move";const t=e.target.closest(".image-thumbnail");if(!t||t===u)return;const a=parseInt(t.dataset.index);p<a?o.insertBefore(u,t.nextSibling):o.insertBefore(u,t),x()},y=()=>{u&&(u.classList.remove("dragging"),u=null)},x=()=>{const e=Array.from(o.children),t=e.map((e=>h[parseInt(e.dataset.index)]));h=t,e.forEach(((e,t)=>{e.dataset.index=t;const a=e.querySelector(".up-arrow"),n=e.querySelector(".down-arrow");0===t?(a.disabled=!0,a.classList.add("disabled")):0!==t&&(a.disabled=!1,a.classList.remove("disabled")),t===h.length-1?(n.disabled=!0,n.classList.add("disabled")):t!==h.length-1&&(n.disabled=!1,n.classList.remove("disabled"))})),I()},I=()=>{if(0===h.length)return void L();t.classList.remove("hidden");const e=B(h),a=C(h,e),n=T(h,a);M(e,n),k(h,a,e,n)},B=e=>d.checked?Math.max(...e.map((e=>e.width))):Math.min(...e.map((e=>e.width))),C=(e,t)=>e.map((e=>t/e.width)),T=(e,t)=>e.map(((e,a)=>e.height*t[a])),M=(t,a)=>{e.width=t,e.height=a.reduce(((e,t)=>e+t),0)},k=(e,t,n,d)=>{let s=0;e.forEach(((e,t)=>{a.drawImage(e,0,s,n,d[t]),s+=d[t]}))},N=e=>{e.matches?c.innerText="Use the arrows to adjust image order.":c.innerText="Drag images to reorder or use the arrows."};function D(e){const t=e.target.files;t.length&&((async e=>{try{L(),l.classList.add("hidden"),o.innerHTML="",h=await Promise.all(Array.from(e).map(E)),h.length>0?(w(),I()):L()}catch(e){console.error(e),L()}})(t),e.target.value="")}g.addEventListener("change",N),N(g),n.removeEventListener("change",D),n.addEventListener("change",D),d.addEventListener("change",I),r.addEventListener("click",(()=>{const t=document.getElementById("filename").value.trim()||"joinedimage",a=e.toDataURL("image/jpeg",.92),n=document.createElement("a");n.href=a,n.download=`${t}.jpg`,n.click()})),s.addEventListener("change",(t=>{t.target.checked?v():(a.clearRect(0,0,e.width,e.height),L(),l.classList.add("hidden"),o.innerHTML="",h=[])})),s.checked&&v()})();